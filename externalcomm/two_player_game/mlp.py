import pynq.lib.dma
from pynq import allocate
from pynq import Overlay
import numpy as np
import pandas as pd
from numpy import mean, std, sqrt, percentile
from scipy.stats import skew, kurtosis
from sklearn.preprocessing import StandardScaler
from slidingwindow import SlidingWindow
import time
import logging
import power


INPUT_NODES = 45
OUTPUT_NODES = 5

ACC_ACTION_THRESHOLD = 42

GRENADE_SHIELD_PERCENTAGE_THRESHOLD = 0.03

GRENADE = 0
RELOAD = 1
SHIELD = 2
NOISE = 3
LOGOUT = 4

print("Uploading bitstream to FPGA...")
overlay = Overlay('mlp.bit')

# power monitoring
power.lower_PL_clk_rate()
rails = pynq.get_rails()
rail_name = 'PSINT_FP'
recorder = pynq.DataRecorder(rails[rail_name].power)

# set up for running bitstream
buffer_input = allocate(shape=(INPUT_NODES,), dtype=np.float32)
buffer_output = allocate(shape=(OUTPUT_NODES,), dtype=np.float32)
dma = overlay.axi_dma_0
action_checker = SlidingWindow()
logging.basicConfig(filename='fpga.log', filemode='a', format='%(asctime)s: %(levelname)s - %(message)s s', level=logging.INFO)

def data_processing(raw_data):
    """
    Performs feature extraction and data normalization
    :param raw_data: Expect raw data of format [[ax, ay, az, gx, gy, gz], ...], arbitrary length is fine
    :return: A processed_data with 55 features => len(processed_data) = 55
    """
    processed_data = list()
    # separate each axis input, so we need 6 lists
    acc_x = list()
    acc_y = list()
    acc_z = list()
    gyro_x = list()
    gyro_y = list()
    gyro_z = list()
    for data in raw_data:
        acc_x.append(data[0])
        acc_y.append(data[1])
        acc_z.append(data[2])
        gyro_x.append(data[3])
        gyro_y.append(data[4])
        gyro_z.append(data[5])
    # do feature extraction for each axis input
    processed_data = feature_extraction(acc_x, acc_y, acc_z, gyro_x, gyro_y, gyro_z, processed_data)
    # expect 45 features
    return processed_data


def feature_extraction(acc_x, acc_y, acc_z, gyro_x, gyro_y, gyro_z, processed_data):
    def extract_features(raw_axis_data):
        loaded = []
        tmean = mean(raw_axis_data)
        tstd = std(raw_axis_data)
        t25percentile = percentile(raw_axis_data, 25)
        trms = sqrt(mean(sum(data**2 for data in raw_axis_data)))
        tskew = skew(raw_axis_data)
        temp = [tmean, tstd, t25percentile, trms, tskew]
        # convert to frequency domain by FFT
        freq_domain = np.fft.rfft(raw_axis_data)
        fmax = abs(max(freq_domain))
        fmin = abs(min(freq_domain))
        energy = sum(abs(freq_domain) ** 2) / 100 ** 2
        freq_temp = [fmax, fmin, energy]
        temp.extend(freq_temp)
        loaded.extend(temp)
        return loaded

    processed_data.extend(extract_features(acc_x))
    processed_data.extend(extract_features(acc_y))
    processed_data.extend(extract_features(acc_z))
    processed_data.extend(extract_features(gyro_x))
    processed_data.extend(extract_features(gyro_y))
    processed_data.extend(extract_features(gyro_z))
    processed_data.extend([max(acc_x), max(acc_y), max(acc_z), min(acc_x), min(acc_y), min(acc_z)])
    colnames = ['tmean_ax', 'tstd_ax', 't25_ax', 'trms_ax', 'tskew_ax', 'fmax_ax', 'fmin_ax', 'fen_ax',
                'tmean_ay', 'tstd_ay', 't25_ay', 'trms_ay', 'tskew_ay', 'fmax_ay', 'fmin_ay', 'fen_ay',
                'tmean_az', 'tstd_az', 't25_az', 'trms_az', 'tskew_az', 'fmax_az', 'fmin_az', 'fen_az',
                'tmean_gx', 'tstd_gx', 't25_gx', 'trms_gx', 'tskew_gx', 'fmax_gx', 'fmin_gx', 'fen_gx',
                'tmean_gy', 'tstd_gy', 't25_gy', 'trms_gy', 'tskew_gy', 'fmax_gy', 'fmin_gy', 'fen_gy',
                'tmean_gz', 'tstd_gz', 't25_gz', 'trms_gz', 'tskew_gz', 'fmax_gz', 'fmin_gz', 'fen_gz',
                'tmax_ax', 'tmax_ay', 'tmax_az', 'tmin_ax', 'tmin_ay', 'tmin_az'
                ]
    df = pd.DataFrame([processed_data], columns=colnames)
    to_drop = ['t25_ax', 'tmean_ay', 'tskew_ay', 't25_az', 'tskew_az', 'fen_az', 'tskew_gx', 'tskew_gy', 'tskew_gz']
    df = df.drop(to_drop, axis=1)
    processed_data = np.array(df).reshape(-1, 1)
    s = StandardScaler()
    s.fit(processed_data)
    processed_data = s.transform(processed_data)
    processed_data = np.hstack(processed_data)
    return processed_data


def _get_output_from_fpga(input_data):
    """
    Implicit function used in get_output_from_FPGA to send input to FPGA and receive output from FPGA
    :param input_data: The processed input data, expect an array with 45 columns
    :return: An integer value in range [0,4] which corresponds to the classification output
    """
    if input_data is None or len(input_data) < INPUT_NODES:
        return 3  # NO_ACTION
    try:
        # copy input_data to input buffer
        for i in range(len(input_data)):
            buffer_input[i] = input_data[i]
        # send input to FPGA and wait for output
        dma.sendchannel.transfer(buffer_input)
        dma.recvchannel.transfer(buffer_output)
        # print("Sending data to input channel")
        dma.sendchannel.wait()  # wait for send channel
        # print("Generating data to output channel")
        dma.recvchannel.wait()  # wait for recv channel
        # print(buffer_output)
        action_no = np.argmax(buffer_output)
        action_no = rectify_action(action_no)
    except Exception as e:
        print("There is an error occurs in FPGA!")
        print(e)
        action_no = NOISE
    return action_no


def rectify_action(from_action):
    """
    Rectify GRENADE to SHIELD in case the two probabilities are close
    :param from_action: the pure output from FPGA, an integer
    :return: The rectified action, might change from 0 to 2 only
    """
    action_no = from_action
    max_percent = max(buffer_output)
    second_max_percent = 0
    second_max = NOISE
    for idx, data in enumerate(buffer_output):
        second_max = idx if second_max_percent < data < max_percent else second_max
        second_max_percent = data if second_max_percent < data < max_percent else second_max_percent
    if from_action == GRENADE:
        if second_max == SHIELD and max_percent - second_max_percent < GRENADE_SHIELD_PERCENTAGE_THRESHOLD:
            # print(buffer_output)
            print("Action has been rectified from GRENADE to SHIELD")
            action_no = SHIELD  # it should be shield
    return action_no


def get_output_from_FPGA(raw_data):
    """
    Processes raw data, send to FPGA and get back output
    :param raw_data: Expect [[ax1, ay1, az1, gx1, gy1, gz1],[ax2, ay2, az2, gx2, gy2, gz2],...]
    :return: action, an integer from 0 to 4 (0 -> grenade, 1 -> reload, 2 -> shield, 3 -> none, 4 -> end)
    """
    start_time = time.time()
    try:
        with recorder.record(0.05):
            input_data = data_processing(raw_data)
            action_checker.clear_window()
            action_checker.fill_window(raw_data)
            if action_checker.get_curr_value() > ACC_ACTION_THRESHOLD:  # this can be an action
                action = _get_output_from_fpga(input_data)
            else:
                print("This is not an action...")
                action = 3
    except Exception as e:
        print("There is an error occurs in FPGA...")
        print(e)
        action = 3
    logging.info(str(time.time() - start_time))
    with open('power.txt', 'w') as file:
        file.write(str(mean(recorder.frame['PSINT_FP_power'])) + '\n')
    recorder.reset()
    return action


def test_FPGA():
    grenade_count = 5
    reload_count = 5
    shield_count = 5
    actions = [[[5.55, 5.29, 13.55, -42.82, -63.32, -81.71],[9.04, 5.8, 25.05, -28.8, -55.33, -75.64],[7.88, 10.55, 34.04, -16.5, -42.38, -71.13],[0.0, 17.47, 37.63, -5.61, -25.84, -70.43],[-19.13, 15.27, 43.87, 6.05, -8.35, -72.22],[-53.25, 16.42, 38.71, 20.99, 8.63, -71.4],[-71.91, 16.22, -1.39, 37.16, 25.35, -66.38],[-63.77, 5.97, -37.92, 52.5, 42.38, -58.78],[-51.8, -4.96, -67.37, 68.66, 60.03, -43.48],[-12.57, -3.89, -83.87, 85.38, 76.79, -4.43],[15.56, -16.14, -65.31, 103.21, 102.27, 108.1],[16.97, -11.75, -32.6, 117.49, 115.38, 130.17],[29.87, 1.05, 4.46, 134.02, 129.73, 140.93],[31.43, 9.71, 50.76, 143.57, 137.35, 147.23],[5.0, -2.24, 12.41, 141.44, 135.01, 147.58],[-8.43, -4.24, -4.95, 143.11, 134.58, 148.9],[16.34, -2.84, 11.88, 148.66, 136.04, 157.78],[40.8, -8.21, 32.62, 147.43, 134.32, 160.1],[63.25, -22.75, 48.87, 136.74, 127.42, 162.12],[69.88, -35.02, 55.69, 116.56, 113.55, 170.22],[23.69, -36.85, 12.66, 83.33, 100.15, -110.76],[7.57, -58.82, -96.96, 48.51, 51.44, -54.16],[-156.76, -21.86, -68.04, 22.45, 10.58, -40.79],[23.65, -25.77, -44.08, 42.72, 42.83, -34.61],[3.48, 33.99, -13.84, 46.17, 33.99, -23.59],],
[[19.62, 0.77, 24.08, -67.32, -120.57, -98.17],[19.34, 9.71, 56.33, -50.57, -131.55, -92.08],[-5.03, 33.88, 84.22, -26.92, -27.94, -88.91],[-35.91, 39.29, 59.54, -2.54, -3.57, -88.76],[-65.76, 29.35, 20.42, 19.58, 18.37, -88.37],[-87.71, 17.05, -22.66, 45.04, 37.74, -77.31],[-71.94, -0.66, -79.02, 68.04, 57.36, -55.35],[-20.25, -24.41, -87.16, 85.18, 80.36, -28.0],[-1.74, -30.28, -69.54, 103.86, 103.61, 97.84],[32.33, -15.4, -51.31, 123.5, 121.13, 126.75],[40.15, -2.85, 8.88, 145.21, 137.03, 141.59],[22.72, 8.57, 6.42, 151.08, 140.25, 142.77],[2.93, 6.57, 12.5, 156.58, 144.9, 150.39],[9.77, -0.57, 12.44, 157.64, 146.64, 153.6],[34.67, -13.55, 36.17, 157.13, 147.19, 155.99],[74.57, -40.27, 55.62, 147.5, 140.94, 157.08],[105.29, -49.83, 19.12, 123.85, 119.61, 165.22],[46.74, -40.28, -47.49, 77.49, 77.74, -88.59],[-61.26, 4.5, -170.88, 36.91, 27.96, -46.82],[-173.73, 12.64, -26.17, 26.79, 11.73, -54.56],[77.5, -37.13, -60.53, 53.44, 47.7, -36.51],[-23.63, 44.78, -8.41, 42.09, 23.87, -42.99],[-11.76, 16.42, 17.64, 41.0, 28.89, -52.21],[-12.95, 13.93, 10.06, 41.04, 25.84, -47.71],],
[[17.65, 1.89, 15.73, -86.74, -117.7, -109.83],[18.83, 13.84, 43.3, -67.76, -123.7, -97.88],[1.77, 29.92, 76.79, -38.82, -39.62, -89.41],[-32.63, 36.83, 71.15, -10.64, -13.92, -86.64],[-44.07, 25.63, 7.84, 16.2, 10.69, -82.7],[-65.69, 21.16, -9.51, 36.87, 31.3, -80.22],[-71.47, -0.51, -37.82, 57.37, 50.93, -69.28],[-54.64, -12.86, -65.58, 76.97, 70.93, -48.09],[-26.1, -21.13, -82.41, 95.22, 79.41, 36.21],[15.82, -19.76, -84.0, 112.6, 112.16, 93.26],[44.75, -4.43, -50.89, 132.32, 125.85, 128.92],[45.98, 1.42, 32.52, 152.44, 142.55, 146.65],[33.15, 2.25, 34.07, 154.88, 145.27, 147.09],[11.88, -12.18, 14.56, 151.79, 143.8, 150.3],[8.07, -8.59, 19.05, 148.32, 142.85, 155.55],[10.69, -17.1, 34.96, 144.68, 141.43, 156.28],[39.46, -33.3, 55.66, 138.43, 136.51, 159.55],[75.77, -51.75, 51.02, 123.52, 121.55, 165.8],[55.26, -33.89, -7.62, 90.48, 95.04, -147.34],[-13.87, -18.49, -141.08, 51.22, 44.56, -43.29],[-165.77, 43.6, -48.48, 36.58, 12.63, -45.96],[59.1, -13.49, -36.52, 62.64, 54.64, -32.78],[3.16, 44.0, 5.01, 48.87, 30.12, -39.74],[-17.73, 24.35, 11.2, 47.79, 32.34, -45.59],[0.37, 11.48, 0.12, 47.65, 32.39, -42.58],],
[[11.99, -1.31, 5.21, -96.79, -114.84, -120.91],[30.58, -2.39, 34.43, -83.54, -118.38, -109.79],[26.15, 13.74, 85.09, -57.47, -133.95, -99.46],[-27.3, 49.81, 102.02, -27.06, -160.7, -97.18],[-69.26, 46.46, 50.38, 3.27, 172.72, -94.01],[-93.31, 41.8, -24.75, 34.04, 29.92, -85.24],[-83.53, 9.27, -65.1, 59.96, 49.64, -69.47],[-56.98, -22.55, -90.05, 80.65, 69.05, -38.6],[-7.9, -27.77, -95.95, 101.54, 74.85, 56.78],[51.78, -23.88, -61.31, 120.74, 118.09, 113.06],[41.05, -5.79, -12.31, 134.72, 128.68, 136.42],[16.23, -2.98, -6.45, 143.07, 136.51, 142.66],[11.51, -4.6, 22.71, 156.98, 151.64, 153.06],[18.75, -10.03, 44.75, 157.97, 154.57, 156.89],[45.49, -27.44, 64.37, 153.63, 150.44, 162.05],[91.58, -48.75, 48.08, 138.89, 133.67, 165.93],[83.18, -62.0, -49.53, 99.43, 99.29, 169.34],[-37.63, -10.02, -163.97, 53.69, 44.39, -34.3],[-161.05, 56.2, -24.84, 35.21, 1.32, -49.71],[41.22, 8.61, -41.56, 65.85, 53.59, -28.53],[4.21, 8.17, -14.65, 51.75, 33.47, -47.79],[-30.84, 29.96, 30.96, 45.34, 26.12, -50.69],[-8.55, 13.07, 10.48, 46.99, 27.27, -47.88],],
[[8.92, -0.52, 6.74, -103.94, -115.87, -116.68],[12.59, -2.95, 21.34, -95.72, -117.32, -109.49],[22.09, 11.71, 50.36, -70.42, -124.08, -96.55],[4.11, 33.46, 63.3, -35.7, -40.72, -87.42],[-26.65, 36.51, 47.08, -14.41, -20.59, -85.54],[-44.67, 24.63, 30.99, 3.54, -0.01, -86.6],[-63.13, 21.02, 14.68, 22.52, 17.44, -84.12],[-73.35, 10.46, -22.99, 41.92, 33.1, -75.61],[-60.78, -4.72, -54.1, 58.74, 50.1, -63.98],[-32.7, -17.72, -79.12, 75.02, 69.65, -52.18],[-8.12, -30.48, -60.41, 86.93, 85.41, -38.56],[-3.5, -15.95, -70.96, 99.03, 80.88, 87.64],[26.85, -11.43, -64.75, 118.29, 115.81, 130.67],[52.41, -13.36, 37.26, 147.72, 139.01, 154.12],[41.67, 23.32, 38.25, 157.98, 142.7, 157.39],[1.76, -1.53, 12.73, 154.09, 141.31, 163.57],[4.84, 6.26, 18.1, 162.02, 143.45, 169.39],[10.65, 7.52, 22.89, 161.95, 145.58, 165.11],[8.97, -11.13, 13.05, 158.56, 146.03, 160.88],[24.4, -16.72, 34.79, 154.66, 146.07, 159.32],[42.2, -45.64, 52.58, 144.35, 140.84, 156.84],[69.47, -69.39, 51.21, 126.55, 126.95, 155.95],[68.3, -47.34, -17.69, 95.43, 100.64, -177.02],[-0.62, -43.45, -150.17, 54.93, 52.35, -54.72],[-171.09, 16.64, -72.05, 30.05, 2.7, -53.08],],
[[16.82, 5.05, 15.74, -146.47, -122.58, -115.48],[39.88, 41.96, 49.91, 167.01, -122.02, -105.83],[8.48, 41.99, 15.0, 90.82, -61.84, -71.97],[-18.84, -1.51, -3.01, 67.91, -64.42, -21.23],[-48.22, -39.41, -1.33, 57.43, -62.35, -0.52],[-23.81, -44.78, 8.61, 39.4, -47.58, -27.4],[-6.32, -13.74, -17.19, 43.3, -39.57, -24.82],[-7.83, -5.08, -21.8, 40.3, -31.88, -28.38],[-10.0, -26.54, -29.69, 35.26, -20.85, -41.45],[-19.56, -44.83, -22.39, 29.41, -8.38, -61.1],[-30.43, -39.04, 2.11, 15.12, 4.13, -83.01],[-22.7, -13.88, 35.14, -9.33, 168.67, -100.41],[-17.26, 16.59, 67.26, -45.64, 165.43, -108.07],[17.0, 124.58, 74.86, -115.95, 159.61, -117.82],[41.24, 101.92, -36.11, 167.51, 1.2, -80.15],[66.58, 23.8, -82.44, -161.21, 19.03, -89.93],[-52.85, -28.92, 13.49, -95.66, 156.12, -109.08],[23.32, 9.21, 2.44, -141.13, 161.37, -103.59],[27.76, 4.7, 20.9, -143.67, 165.6, -102.21],[-2.13, -0.61, 8.61, -129.24, 162.07, -101.15],[-8.22, -1.19, -0.57, -133.27, 161.73, -99.64],],
[[24.62, 1.27, 15.55, -121.19, -120.66, -123.36],[43.03, 10.38, 74.82, -121.56, -122.77, -111.59],[-25.03, 55.34, 35.04, 72.84, -59.07, -69.81],[-25.81, 23.31, -11.42, 53.08, -49.98, -26.09],[-47.5, -19.39, -3.52, 37.14, -42.47, -24.06],[-38.35, -37.42, -17.82, 21.33, -23.32, -42.79],[-4.1, -35.45, -33.13, 22.69, -5.91, -51.37],[-2.96, -5.75, -24.3, 22.93, -0.51, -57.26],[0.25, -1.39, -8.4, 27.41, 4.78, -57.16],[-3.94, -9.8, -15.83, 32.56, 9.44, -56.97],[-7.65, -33.93, -17.1, 35.12, 18.34, -66.12],[-16.14, -61.16, -2.55, 33.19, 28.42, -82.54],[-41.77, -50.02, 13.85, 24.67, 148.45, -97.62],[-62.82, 26.16, 48.41, -11.96, 152.12, -110.68],[-13.44, 127.35, 63.08, -105.19, 150.3, -114.81],[4.13, 112.17, -16.01, -172.28, 14.51, -85.96],[67.93, 12.38, -24.87, -102.79, 150.6, -109.39],[-38.97, -17.0, 14.86, -94.8, 148.71, -110.47],[21.6, 10.6, -2.43, -134.85, 154.55, -100.36],[26.93, 8.38, 6.66, -118.27, 154.06, -105.55],[-9.46, -5.43, 11.8, -105.89, 152.86, -107.39],],
[[11.55, 2.23, 10.69, -123.71, -121.77, -122.96],[20.06, 12.54, 44.65, -126.03, -124.41, -116.51],[1.46, 38.79, 67.87, -165.09, -125.74, -96.23],[-21.6, 36.64, 4.7, 71.36, -52.61, -50.65],[-14.26, 1.0, -12.35, 68.57, -46.72, -17.38],[-23.18, -17.6, -16.68, 59.28, -38.82, -12.44],[-26.83, -44.63, -14.32, 48.17, -22.09, -23.18],[-18.63, -39.63, -18.76, 47.63, -4.88, -31.36],[0.18, -14.58, -31.25, 49.39, 5.13, -33.23],[15.48, -27.96, -31.91, 48.65, 17.12, -42.45],[18.52, -37.38, -17.31, 44.85, 31.51, -64.68],[-30.81, -45.81, 14.31, 29.74, 28.29, -88.04],[-43.17, 8.5, 30.59, 5.29, 158.07, -100.4],[-57.95, 60.01, 53.26, -29.01, 156.29, -109.46],[-42.33, 93.49, 75.06, -89.91, 154.56, -108.47],[-45.3, 91.08, -73.42, 155.63, 23.64, -82.44],[68.63, 25.35, -67.08, -148.69, 149.84, -90.13],[-37.52, -17.45, 21.1, -83.64, 151.14, -102.43],[15.67, 8.7, -2.12, -141.61, 155.58, -94.22],[18.3, 6.82, 15.26, -120.16, 154.86, -98.43],[2.67, -1.74, 11.17, -122.83, 153.76, -96.32],],
[[21.27, 12.21, 33.24, -135.9, -123.34, -118.08],[19.72, 45.38, 56.38, -175.33, -123.86, -101.91],[-12.9, 32.67, 19.91, 75.32, -58.72, -59.48],[-25.59, -6.81, 19.52, 59.38, -54.69, -22.75],[-33.61, -32.8, 8.51, 36.91, -40.36, -32.38],[-21.39, -39.59, -7.03, 16.75, -16.83, -55.36],[-13.33, -30.04, -33.39, 19.62, 3.5, -70.84],[-13.3, -20.09, -35.57, 24.17, 16.95, -81.02],[-7.85, -39.66, -51.35, 30.64, 29.37, -87.74],[-12.98, -80.25, -20.86, 29.07, 145.74, -98.21],[-28.9, -30.13, 17.35, 9.97, 149.46, -107.13],[-55.74, 36.53, 88.56, -43.05, 158.01, -115.14],[70.63, 131.19, 36.56, -130.03, 154.62, -110.58],[19.29, 135.68, -73.09, 168.52, 16.65, -74.2],[12.58, -8.5, -59.16, -95.07, 145.31, -94.1],[-38.98, -15.24, 1.23, -108.45, 146.47, -100.63],[30.75, 17.93, 9.11, -151.37, 154.96, -91.65],[12.74, 9.58, 3.71, -120.01, 149.91, -95.84],[8.24, 2.72, 3.25, -127.14, 152.16, -95.23],],
[[42.54, 2.57, 33.48, -115.29, -124.47, -125.37],[57.48, 32.54, 79.31, -110.68, -124.72, -103.12],[-48.42, 52.98, 30.41, 48.26, -50.24, -35.63],[-77.12, -26.24, -36.34, 29.99, -35.91, -29.36],[-71.53, -86.73, 5.77, 11.12, -16.03, -59.41],[-24.48, -60.4, -39.1, 21.58, 5.03, -64.42],[-2.32, -16.14, -71.68, 32.76, 15.33, -69.13],[5.45, -27.82, -51.3, 28.52, 23.13, -82.05],[-10.38, -70.83, -31.15, 29.16, 149.19, -92.65],[-37.4, -38.49, 7.01, 13.67, 152.23, -103.65],[-63.81, -3.13, 102.83, -22.36, 158.07, -115.93],[9.94, 180.4, 52.64, -120.85, 152.65, -113.71],[-21.27, 164.74, -57.58, -149.95, 155.72, -93.68],[-40.75, -5.77, -27.64, -94.86, 141.94, -107.0],[26.18, 24.57, -3.73, -127.19, 149.1, -101.25],[18.03, 8.96, 15.64, -85.21, 147.25, -112.24],[12.91, 7.53, 5.69, -93.01, 150.8, -105.15],[11.0, 4.52, -0.2, -91.44, 151.98, -107.3],[6.84, 9.69, -12.02, -97.5, 153.88, -109.76],[11.74, 21.28, -12.76, -110.77, 156.23, -110.76],],
[[-8.99, -15.67, 2.75, -167.31, -114.6, -129.31],[-12.09, -25.14, 8.87, -158.58, -121.12, -126.11],[-18.9, -25.57, 25.27, -151.02, -132.78, -125.68],[-15.15, -9.32, 59.15, -146.62, -149.44, -128.0],[-4.89, 32.14, 69.48, -151.63, -166.53, -128.17],[28.38, 48.56, 55.84, -156.57, 179.16, -125.34],[60.38, 57.1, -10.27, -153.7, 163.42, -116.95],[85.94, 32.4, -35.9, -150.65, 154.59, -113.38],[74.89, 32.47, -25.1, -144.85, 147.74, -108.41],[55.41, 49.14, -33.23, -138.87, 140.84, -100.34],[4.78, 52.69, -52.11, -125.24, 131.75, -103.63],[-112.14, 22.22, -10.82, -87.15, 123.41, -117.84],[-91.28, -54.89, -26.16, -42.4, 110.82, -108.94],[-25.22, -39.25, -36.01, -52.66, 105.69, -101.66],[5.02, -14.22, -42.6, -104.37, 107.87, -91.07],[3.81, -4.49, -46.31, -97.92, 115.04, -94.6],[-0.21, -2.07, -52.52, -77.89, 127.6, -98.24],[-12.4, 14.18, -36.64, -71.56, 143.48, -104.45],[-2.78, 18.41, -11.55, -85.13, 160.81, -111.62],[40.92, 10.51, 7.23, -105.4, 178.83, -121.63],[19.51, -22.89, 37.1, -104.39, -154.48, -127.8],[12.42, -52.02, 61.29, -118.39, -131.52, -132.6],[0.61, -83.17, 101.12, -157.08, -118.8, -156.97],[-11.2, -48.34, 6.96, -176.71, -109.37, -128.69],[-11.41, 10.01, -9.28, 150.08, -112.07, -123.49],],
[[-10.25, -15.36, 4.19, 158.82, -113.3, -128.35],[-18.89, -32.78, 19.29, 177.7, -120.72, -125.5],[-7.5, -49.7, 67.81, -150.67, -136.34, -127.46],[16.47, 7.67, 98.69, -139.83, -159.73, -129.61],[59.09, 56.19, 53.24, -137.41, 176.5, -127.91],[80.52, 70.06, -5.33, -136.38, 156.77, -119.82],[53.73, 71.86, -29.54, -141.49, 149.91, -104.07],[2.91, 76.49, -23.75, -149.46, 151.84, -92.84],[-31.28, 78.46, -60.19, -139.27, 143.45, -93.68],[-41.43, 42.24, -66.14, -118.33, 134.69, -101.37],[-57.74, -24.41, -44.78, -106.14, 125.08, -97.28],[-32.02, -57.81, -35.67, 177.56, 60.03, -80.16],[-6.89, -36.11, -14.64, 157.49, 58.15, -73.26],[-2.13, -17.39, -16.36, -179.85, 56.48, -74.63],[3.84, -4.43, -36.39, -146.18, 52.5, -82.37],[-0.54, -1.22, -45.66, -118.87, 133.37, -97.08],[4.46, 2.67, -39.24, -106.6, 145.19, -107.82],[9.38, 4.24, -32.4, -110.75, 160.4, -110.21],[14.01, 26.05, -11.41, -122.39, -179.8, -110.74],[7.52, -3.11, 26.36, -111.9, -152.27, -118.88],[19.59, -55.56, 95.22, -139.64, -127.09, -139.58],[7.24, -114.23, 108.81, -143.69, -119.84, -160.71],[-9.23, -51.04, -10.17, -99.7, -113.74, -105.1],[-15.3, 30.76, -13.43, 146.65, -118.17, -111.01],[-18.5, 20.49, -6.18, 171.41, -118.05, -120.16],],
[[-9.69, -14.32, -3.72, -142.38, -109.74, -126.76],[-13.68, -20.21, 4.21, -170.65, -112.66, -127.98],[-5.82, -11.9, 26.49, 174.63, -120.49, -123.05],[-8.62, -3.62, 76.52, -159.79, -139.4, -121.74],[22.0, 24.31, 120.08, -129.77, -166.98, -129.08],[104.4, 109.32, 58.13, -125.65, 163.4, -130.2],[54.39, 130.0, -77.38, -134.15, 143.46, -103.19],[-4.62, 44.54, -106.96, -140.55, 49.14, -79.27],[-76.2, -13.67, -47.58, -83.28, 114.18, -100.34],[-34.78, -22.81, -73.99, -166.79, 65.55, -78.37],[-10.98, 0.71, -47.36, 147.83, 58.54, -74.85],[-16.18, -11.9, -48.86, 131.26, 58.66, -74.13],[-7.54, -1.6, -55.09, 140.53, 54.63, -78.88],[-7.67, -1.31, -58.13, 154.93, 48.27, -87.82],[-14.89, 9.71, -46.61, -50.36, 143.93, -100.69],[4.93, 23.3, -14.56, -66.29, 161.71, -111.97],[46.43, 21.91, -10.83, -82.01, -175.41, -118.45],[22.88, -25.3, 42.5, -87.08, -147.06, -127.64],[21.27, -65.39, 105.53, -107.94, -127.16, -143.4],[-2.75, -102.7, 85.08, -124.03, -113.91, -164.17],[-8.56, -37.96, -21.41, -125.0, -108.48, -162.53],[10.23, 1.14, -0.47, -121.09, -115.98, -147.1],[8.1, -3.76, -7.38, -109.31, -123.09, -133.79],],
[[-7.51, -11.25, -7.52, -141.68, -107.98, -126.96],[-15.97, -38.16, -6.4, -150.9, -108.38, -130.29],[-26.05, -56.37, 11.12, -154.69, -116.45, -129.48],[-22.03, -36.6, 67.88, -159.48, -133.41, -127.52],[-0.48, 27.45, 120.19, -160.4, -156.57, -124.89],[52.72, 109.28, 109.64, -161.6, -177.19, -118.85],[147.61, 125.43, 14.47, -149.74, 159.49, -111.71],[100.09, 92.67, -69.91, -140.76, 144.06, -100.24],[13.37, 62.14, -81.05, -130.78, 132.94, -94.18],[-129.63, 12.25, -57.02, -106.99, 118.8, -99.64],[-49.0, -43.32, -105.61, 174.58, 61.8, -63.91],[-10.83, -21.25, -65.36, 158.91, 61.3, -64.09],[-2.83, -21.88, -46.94, 151.88, 63.66, -61.42],[-1.88, -12.19, -41.86, 157.65, 61.68, -69.66],[-11.05, -3.78, -50.42, -166.44, 55.63, -83.94],[-15.57, 11.66, -47.19, -86.91, 135.04, -99.53],[-1.93, 22.0, -27.53, -69.25, 151.53, -114.39],[15.77, 24.91, -5.39, -88.33, 170.04, -124.19],[-1.65, -15.65, 44.38, -78.62, -160.07, -123.0],[40.06, -43.05, 62.65, -89.75, -131.66, -135.2],[58.19, -96.41, 134.47, -119.26, -125.88, -163.23],[28.99, -62.35, 18.84, -90.2, -110.38, -137.72],[-24.09, -15.24, -28.02, -100.91, -113.67, -129.02],[-19.41, 19.28, 14.56, -142.7, -117.38, -131.83],[-16.25, 17.8, -10.3, -141.63, -118.38, -124.42],],
[[-4.98, -19.33, -1.75, -128.75, -112.09, -132.35],[-19.51, -56.99, 12.28, -127.28, -116.0, -132.72],[-26.6, -49.56, 53.62, -136.18, -129.7, -127.69],[-15.39, 25.58, 121.85, -147.53, -154.48, -127.07],[59.05, 120.93, 126.56, -146.67, 178.7, -126.29],[184.46, 122.69, -4.18, -134.6, 151.11, -126.25],[75.33, 88.27, -86.65, -133.04, 135.01, -95.56],[-64.57, 36.19, -118.7, -115.5, 119.04, -93.28],[-108.24, -46.88, -83.95, -133.49, 73.25, -78.93],[-9.1, 12.86, -93.65, -171.79, 53.75, -59.38],[12.96, 10.34, -51.61, -178.35, 58.75, -60.36],[-8.61, -16.2, -60.06, 164.85, 61.8, -54.28],[-5.38, 6.18, -52.96, 179.14, 56.61, -65.53],[-12.88, 6.73, -50.12, -160.78, 50.41, -78.41],[6.66, 13.4, -48.91, -125.95, 138.28, -93.71],[15.99, 27.57, -28.72, -94.23, 157.03, -110.12],[-25.92, -1.5, -23.23, -74.88, -171.37, -112.62],[16.11, -35.82, 47.42, -84.75, -143.51, -124.28],[40.7, -91.32, 120.85, -134.03, -126.92, -165.89],[42.31, -114.09, 67.61, -102.87, -111.7, -161.63],[-38.06, -60.62, -42.38, -61.35, -68.21, -76.78],[6.92, 16.21, -9.38, -151.25, -115.37, -135.81],[-15.69, 22.52, 2.17, -149.18, -116.45, -132.75],],
[[15.52, -1.13, 18.52, -106.06, -118.69, -125.91],[16.17, 23.56, 37.98, -89.79, -122.62, -109.57],[0.52, 31.19, 24.21, -53.35, -130.77, -92.52],[-9.43, 10.04, 2.99, -32.32, -37.65, -85.24],[-13.05, -18.92, -2.67, -19.46, -25.89, -82.07],[-22.53, -49.77, -15.13, -7.85, -16.3, -78.31],[-35.38, -58.92, -14.98, -0.1, -10.01, -78.08],[-53.1, -36.27, 3.42, 6.26, -4.81, -80.87],[-52.35, 9.48, 3.82, 16.19, 0.82, -83.13],[-21.03, 47.78, -1.55, 51.88, 5.91, -84.32],[22.25, 53.85, -4.73, 151.04, 8.67, -81.28],[49.68, 40.58, -9.0, 156.98, 10.01, -74.49],[58.48, 26.31, -17.31, 158.29, 11.13, -71.46],[48.93, 31.57, -8.64, 156.02, 10.97, -72.2],[29.88, 42.3, 3.99, 133.06, 9.08, -68.77],[10.28, 42.68, 3.91, 94.4, 6.54, -62.35],[-14.33, 29.8, -4.35, 61.7, 3.95, -57.88],[-44.6, 0.07, -1.98, 36.91, 1.4, -56.64],[-51.77, -39.82, 8.06, 19.88, -0.04, -60.03],[-29.19, -73.82, 16.53, 11.99, 1.4, -66.15],[-13.81, -82.94, 20.46, 12.75, 5.59, -71.38],[-24.32, -70.12, 14.81, 17.41, 8.25, -72.87],[-41.35, -36.17, 8.04, 25.73, 10.95, -72.84],[-45.57, 6.1, -1.82, 42.57, 12.8, -70.78],[-11.98, 49.74, -1.95, 81.41, 14.19, -66.97],],
[[8.9, -5.47, 17.81, -87.98, -121.97, -118.97],[7.17, 14.92, 42.96, -74.14, -129.9, -111.54],[0.31, 33.53, 51.43, -50.16, -145.24, -104.94],[-8.24, 19.05, 4.96, -25.51, -160.37, -97.86],[-10.2, -30.67, -19.24, -8.2, -173.01, -92.05],[-34.48, -82.91, -16.17, 4.37, 2.3, -86.74],[-75.48, -55.42, -14.41, 15.02, 7.37, -83.07],[-59.1, 25.61, -24.97, 40.7, 8.91, -78.32],[8.84, 59.0, -16.4, 108.19, 8.86, -73.58],[40.74, 48.83, -7.95, 142.29, 6.99, -69.87],[82.87, 41.82, -1.45, 138.9, 4.56, -63.77],[59.62, 54.68, -4.04, 128.23, 4.12, -65.03],[21.73, 59.73, 1.04, 91.29, 3.07, -65.24],[-38.25, 38.9, -6.43, 47.86, 1.68, -61.69],[-68.33, -27.88, -5.73, 25.82, 0.64, -57.97],[-57.65, -62.52, 7.91, 10.3, -0.31, -65.63],[-15.26, -77.89, 41.42, 7.25, 5.03, -80.25],[-13.49, -89.91, 24.93, 11.69, 9.92, -83.28],[-52.68, -59.16, 13.68, 16.6, 12.58, -83.22],[-67.2, 1.09, -4.09, 28.9, 12.78, -78.19],[-17.48, 69.56, -4.65, 78.41, 7.81, -68.73],[45.82, 73.81, -4.61, 121.59, 6.31, -57.97],[92.68, 45.54, 3.65, 128.73, 5.0, -45.3],[96.89, 27.47, -16.23, 127.96, 6.18, -41.03],[67.47, 49.4, -14.31, 120.86, 4.07, -52.14],],
[[14.89, -0.86, 13.06, -94.68, -121.16, -123.62],[9.7, 7.12, 51.5, -82.4, -129.45, -118.86],[7.94, 47.77, 104.11, -55.68, -150.94, -115.68],[-22.04, 45.61, 23.39, -17.99, -173.03, -105.28],[-27.28, -1.44, -56.24, 10.32, 8.68, -87.48],[-10.81, -19.9, -74.92, 24.04, 19.26, -78.31],[3.0, -90.9, -51.51, 28.74, 28.29, -85.93],[-58.98, -95.54, -4.26, 26.88, 151.46, -95.94],[-104.62, -17.38, -5.1, 19.33, 159.07, -91.68],[-59.47, 85.26, 1.58, 47.55, 6.65, -83.08],[35.48, 96.81, 28.38, 129.65, -1.07, -72.28],[102.83, 63.26, 21.09, 124.3, -3.88, -54.99],[97.23, 37.27, -0.23, 115.65, -0.96, -47.34],[68.73, 39.75, -6.41, 108.13, 0.61, -57.77],[18.02, 59.33, 6.04, 70.92, 0.84, -69.73],[-64.45, 29.93, -4.92, 28.88, 1.93, -71.12],[-78.3, -49.14, -9.33, 13.75, 3.17, -72.43],[-47.05, -76.55, 4.68, 6.01, 3.09, -79.34],[-13.34, -87.55, 37.6, 5.77, 173.83, -93.27],[-35.89, -84.15, 23.55, 8.96, 170.0, -93.4],[-63.05, -41.47, 0.52, 13.75, 13.72, -89.96],[-59.3, 25.73, -8.88, 21.22, 15.16, -86.91],[18.57, 77.94, -3.54, 119.69, 9.46, -79.67],[78.27, 69.01, 6.22, 150.15, 6.36, -71.68],[137.62, 48.95, 15.03, 138.47, 4.55, -59.28],],
[[7.08, -0.66, 15.39, -89.68, -122.5, -122.82],[15.31, 10.76, 51.31, -74.78, -130.73, -117.46],[8.98, 40.07, 89.73, -48.27, -152.86, -117.52],[-2.77, 28.43, 21.4, -18.16, -172.67, -112.15],[-21.43, -9.94, -36.0, 2.43, 170.74, -103.2],[-21.62, -40.94, -42.82, 17.12, 159.67, -98.96],[-34.67, -92.7, -17.91, 26.35, 150.58, -104.06],[-99.28, -64.07, -21.04, 23.62, 149.61, -101.23],[-108.39, 34.03, -34.19, 22.9, 22.37, -89.81],[6.03, 109.74, -15.46, 155.57, 6.84, -79.38],[70.89, 69.58, 8.96, 165.65, 2.73, -76.77],[137.39, 35.74, 24.57, 161.76, 0.38, -71.05],[90.0, 39.95, -0.57, 161.14, 4.99, -72.66],[36.31, 60.13, 6.14, 143.65, 6.36, -74.69],[-28.73, 58.68, -17.09, 67.7, 7.95, -72.9],[-80.9, 3.02, -29.56, 28.13, 11.63, -76.01],[-66.32, -49.56, 2.13, 17.66, 14.8, -83.96],[-36.18, -90.19, 24.61, 13.17, 166.11, -94.73],[-5.43, -96.48, 47.76, 17.37, 162.84, -101.25],[-32.51, -89.49, 17.11, 18.64, 160.24, -97.07],[-62.52, -39.98, -3.78, 20.98, 157.41, -92.76],[-66.24, 47.01, -21.1, 26.9, 19.27, -86.85],[21.56, 88.64, 7.38, 152.67, 8.72, -80.61],[104.85, 63.11, 32.86, 148.91, 3.53, -68.33],[117.13, 50.84, 11.4, 130.56, 4.86, -49.69],],
[[9.85, -2.11, 0.78, -91.86, -123.1, -129.3],[19.8, -24.56, 33.2, -90.65, -123.42, -127.68],[6.2, 13.33, 88.36, -80.55, -136.39, -119.05],[5.56, 70.39, 52.64, -41.21, -156.7, -105.21],[3.38, 35.75, -33.59, -5.88, -176.58, -93.74],[-8.24, 2.49, -41.09, 9.37, 169.81, -91.92],[-31.13, -80.89, -7.74, 17.22, 161.68, -95.77],[-91.32, -112.47, -10.04, 18.17, 159.97, -94.66],[-125.75, -9.29, -30.79, 20.09, 14.34, -85.7],[-66.41, 84.51, -40.29, 75.26, 7.65, -77.62],[53.6, 104.68, 12.45, 149.75, 0.57, -75.48],[135.86, 54.2, 31.43, 144.74, -3.48, -64.26],[111.83, 42.53, -5.19, 138.89, 0.19, -60.44],[59.37, 60.63, -10.6, 124.17, 3.19, -67.96],[-28.7, 68.78, -13.32, 57.67, 5.36, -73.28],[-87.98, -5.56, -33.31, 23.06, 9.39, -76.7],[-74.39, -86.77, 22.02, 14.29, 13.15, -86.82],[-25.23, -133.33, 23.39, 15.24, 164.72, -90.42],[-35.14, -107.0, 18.4, 20.27, 159.09, -93.36],[-70.97, -44.53, 1.87, 20.64, 18.92, -87.35],[-46.3, 56.44, 11.61, 21.91, 14.29, -86.92],[12.78, 86.28, 23.55, 148.95, 12.11, -83.26],[72.11, 71.22, 11.34, 149.1, 8.09, -69.06],[109.8, 47.42, 14.78, 137.5, 5.94, -52.24],[86.25, 33.56, -34.54, 131.39, 12.99, -48.54],],
[[6.82, -6.89, 13.88, -84.98, -125.15, -123.19],[5.78, -5.78, 36.26, -76.0, -136.2, -122.94],[20.71, 24.76, 70.24, -61.88, -153.39, -125.35],[16.12, 63.49, 41.53, -40.13, -169.31, -121.72],[-3.07, 41.55, -15.54, -15.05, 176.69, -110.01],[-17.95, 18.86, -41.89, 6.76, 166.18, -100.02],[-23.95, -40.05, -38.92, 18.08, 160.52, -94.04],[-30.51, -64.43, -33.92, 20.31, 20.03, -88.81],[-41.31, -83.19, -20.52, 19.07, 18.73, -88.58],[-67.49, -53.45, 2.05, 16.94, 161.16, -93.83],[-84.19, 5.62, 11.94, 9.92, 162.83, -95.86],[-54.22, 80.35, 14.25, -56.28, 166.7, -96.73],[71.72, 84.94, 24.91, -160.91, 170.24, -94.37],[101.93, 42.31, 8.2, -172.58, 10.76, -87.27],[118.76, 30.28, -4.45, 179.81, 13.02, -79.36],[61.89, 41.02, -19.16, 174.08, 12.76, -79.27],[35.42, 61.45, 14.0, 161.24, 8.69, -82.36],[-32.43, 53.63, 13.52, 65.06, 4.2, -72.3],[-78.06, 7.68, -16.95, 34.13, 3.6, -62.85],[-98.49, -50.94, 0.79, 16.61, 4.63, -65.75],[-34.89, -103.59, -7.48, 10.45, 9.16, -77.83],[-4.66, -89.35, 53.15, 15.41, 165.35, -97.2],[-20.71, -102.53, 27.91, 19.31, 160.66, -97.74],[-71.58, -49.77, 18.88, 22.64, 153.48, -101.11],[-78.17, 20.09, -15.06, 27.75, 148.83, -93.07],],
]

    correct = 0
    for idx, raw_action in enumerate(actions):
        prediction = get_output_from_FPGA(raw_action)
        if idx < grenade_count:
            ans = 0
        elif idx < grenade_count + reload_count:
            ans = 1
        elif idx < grenade_count + reload_count + shield_count:
            ans = 2
        else:
            ans = 4
        if prediction == ans:
            correct += 1
        print("FPGA:", prediction, "| TRUE:", ans)
    print("Accuracy:", correct/len(actions))


test_FPGA()

# print("0: Grenade\n1: Reload\n2: Shield\n3: No Action\n4: End")

